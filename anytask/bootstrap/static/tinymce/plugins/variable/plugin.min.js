tinymce.PluginManager.add("variable",function(e){function t(t){return function(){var n=e.settings.variables;t(n)}}function n(t){function n(t){function n(t){if(-1==t.indexOf("<html>")){var n="";tinymce.each(e.contentCSS,function(t){n+='<link type="text/css" rel="stylesheet" href="'+e.documentBaseURI.toAbsolute(t)+'">'});var i=e.settings.body_class||"";-1!=i.indexOf("=")&&(i=e.getParam("body_class","","hash"),i=i[e.id]||""),t="<!DOCTYPE html><html><head>"+n+'</head><body class="'+i+'">'+t+"</body></html>"}var l=a.find("iframe")[0].getEl().contentWindow.document;l.open(),l.write(t),l.close()}var i=t.control.value();i.url?tinymce.util.XHR.send({url:i.url,success:function(e){l=e,n(l)}}):(l=i.content,n(l)),a.find("#description")[0].text(t.control.value().description)}var a,l,c=[];if(!t||0===t.length){var o=e.translate("No variables defined.");return void e.notificationManager.open({text:o,type:"info"})}tinymce.each(t,function(e){c.push({selected:!c.length,text:e.title,value:{url:e.url,content:e.content,description:e.description}})}),a=e.windowManager.open({title:"Insert variable",layout:"flex",direction:"column",align:"stretch",padding:15,spacing:10,items:[{type:"form",flex:0,padding:0,items:[{type:"container",label:"Variables",items:{type:"listbox",label:"Variables",name:"variable",values:c,onselect:n}}]},{type:"label",name:"description",label:"Description",text:"Â "},{type:"iframe",flex:1,border:1}],onsubmit:function(){i(!1,l)},minWidth:Math.min(tinymce.DOM.getViewPort().w,e.getParam("variable_popup_width",300)),minHeight:Math.min(tinymce.DOM.getViewPort().h,e.getParam("variable_popup_height",210))}),a.find("listbox")[0].fire("select")}function i(t,n){function i(e,t){return new RegExp("\\b"+t+"\\b","g").test(e.className)}var l,c,o=e.dom,r=e.selection.getContent();l=o.create("div",null,n),c=o.select(".mceTmpl",l),c&&c.length>0&&(l=o.create("div",null),l.appendChild(c[0].cloneNode(!0))),a(o.select("*",l),function(t){i(t,e.getParam("variable_selected_content_classes","selcontent").replace(/\s+/g,"|"))&&(t.innerHTML=r)}),e.execCommand("mceInsertContent",!1,l.innerHTML),e.addVisual()}var a=tinymce.each;e.addCommand("mceInsertVariable",i),e.addButton("variable",{title:"Insert variable",icon:"template",onclick:t(n)}),e.addMenuItem("variable",{text:"Variable",onclick:t(n),context:"insert"})});
{% extends "base.html" %}
{% load i18n %}
{% load sanitize_html %}
{% load django_bootstrap_breadcrumbs %}

{% block title %}{{ course.name }} | {{ course.year }}{% endblock %}

{% block scripts %}
    {% include "courses/course_js.html" %}
    <style type="text/css">
      body {
        background: white;
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .table .no-font-weight {
        font-weight: normal;
        white-space: nowrap;
        background-color: white;
      }
      .header_sortable {
        cursor: pointer;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
      table {
        //table-layout: fixed;
      }
      .fixedsticky { top: 120px; }
      .form-control {
          resize: both;
          margin: 0;
          padding: 0;
          fill: none;
          background: transparent;
          border: none;
          color: white;
          width: 15px;
          height: inherit;
          font-size: inherit;
          text-align: center;
      }
    </style>
{% endblock %}


{% block breadcrumbs %}
    {{ block.super }}
    {% if school %}
        {% breadcrumb school.name school.get_absolute_url %}
    {% endif %}
    {% if not seminar %}
        {% breadcrumb course.name "" %}
    {% else %}
        {% breadcrumb course.name course.get_absolute_url %}
        {% breadcrumb seminar.title "" %}
    {% endif %}
{% endblock breadcrumbs %}

{% block navbar %}
    <ul class="nav navbar-nav">
        <li class="nav-item active">
            <a class="nav-link" href="{{ course.get_absolute_url }}"> {% if not seminar %}{% trans "stranica_kursa" %}{% else %}
                {% trans "stranica_seminara" %}{% endif %}</a>
        </li>
        {% if not seminar %}
            {% if user_is_teacher %}
                <li class="nav-item">
                    <a class="nav-link" href="{{ course.get_absolute_url }}/queue">{% trans "ochered_na_proverku" %}</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url "courses.views.course_settings" course.id %}">{% trans "nastrojki" %}</a>
                </li>
            {% endif %}
            <li class="nav-item">
                <a class="nav-link" href="{% url "courses.views.view_statistic" course.id %}">Статистика</a>
            </li>
        {% endif %}
    </ul>
{% endblock navbar %}



{% block content %}

    {{ block.super }}

<dl>
	<dt><h3>{{ course.name }} <small>{{ course.year }}</small>
    {% if course.can_edit %}
        <a class="btn btn-secondary btn-sm btn-square" id="edit_course_info_btn">
        <span class="fa fa-pencil"></span></a></h3>
    {% endif%}
    </dt>

    {% if user_is_teacher %}
    <a class="btn-small" href="/new_task/create/{{course.id}}">Добавить задачу</a>
    {% endif %}

	<dd>Преподаватели:
		{% for teacher in course.teachers.all %}
			<a href="{% url "users.views.profile" teacher.username %}">{{ teacher.last_name }} {{ teacher.first_name }}</a>{% if not forloop.last %},{% endif %}
		{% endfor %}
	</dd>

{#	<dd>{% if course.take_policy == 0 %} Студент берет задачу самостоятельно. {% endif %}</dd>#}
{#	{% if course.max_users_per_task %} <dd>Максимальное число студентов на задачу: {{ course.max_users_per_task }}</dd> {% endif %}#}
{##}
{#	{% if course.max_days_without_score %}#}
{#		<dd>Если задача не будет оценена в течении {{ course.max_days_without_score }} дней, то заявка отменяется автоматически.</dd>#}
{#	{% endif %}#}
{##}
{#	{% if course.days_drop_from_blacklist %}#}
{#		<dd>После автоматической отмены заявки задачу можно будет взять через {{ course.days_drop_from_blacklist }} дней.</dd>#}
{#	{% endif %}#}
{##}
{#	{% if course.max_tasks_without_score_per_student %}#}
{#		<dd>У каждого студента может быть не более {{ course.max_tasks_without_score_per_student }} неоцененных задач.</dd>#}
{#	{% endif %}#}
	<dd>
		{% if course.information %}<br>{% endif %}
        <div id="course-information">{{ course.information|sanitize|safe }}</div>
	</dd>

</dl>

<div class="row">
	<div class="span9">
		<table class="table">
			<tbody>
				{% for task,task_takens in tasks_taken %}
					<tr>
						{% if task.is_shown %}
						<td {% if task.is_hidden %} style="color:gray" {% endif %}>
							<strong><div id="{{task.id}}"></div>{{ task.title }}</strong>
							{% if not task.has_subtasks %}
                                <span class="label label-success">{{ task.score_max }}</span>
                                <span class="label {% if task_takens|length < task.max_commands %} label-info {% else %} label-danger {% endif %}">
                                    занято {{ task_takens|length }} команд из {{ task.max_commands }}
                                </span>
							{% endif %}
							{% if task.can_score %}
                                <a href="{% url "command_tasks.views.task_edit_page" task.id %}"><span class="fa fa-pencil"></span></a>
                            {% endif %}
							{% if task.can_take.0  %}
								<a href="{% url "courses.new_pythontask.get_task" course_id=course.id task_id=task.id %}">{% trans "sozdat_komandu" %}</a>
                            {% else %}
                                {% if task.can_take.1 %}
                                    <span class="fa fa-minus-circle" style="color:#d9534f" title="{{ task.can_take.1 }}"></span>
                                {% endif %}
							{% endif %}

							<br>
							{% if task.task_text %}
								{{ task.task_text|safe }}
							{% endif %}
							<br>

									{% for num,task_taken in task_takens %}
                                        <i>Команда {{ num }}</i>
                                        {% if task.can_score %}
                                                    <a href="{% url "courses.new_pythontask.get_or_create_issue" task_id=task.id task_taken_id=task_taken.id %}">Оценить</a>
                                        {% elif task_taken.can_pass.0 %}
                                &nbsp;<a href="{% url "courses.new_pythontask.get_or_create_issue" task_id=task.id task_taken_id=task_taken.id %}">Сдать</a>
                                        {% endif %}
                                        {% if task_taken.can_join.0  %}
                                        <a href="{% url "courses.new_pythontask.join_team" course_id=course.id task_id=task.id task_taken_id=task_taken.id %}">{% trans "vstupit_v_komandu" %}</a>
                                        {% endif %}
                                        <table class="table table-striped table-condensed">
									    <tbody>
										<tr>
											<td style="width:30%">
												{{ task_taken.first_user.last_name }} {{ task_taken.first_user.first_name }}
											</td>
                                            <td style="width:20%">
                                                {% if task.can_score %}
                                                <form action={% url "courses.new_pythontask.score_task" %}>
                                                        <fieldset class="form-group">
                                                            <input type="hidden" name="course_id" value={{ course.id }}>
                                                            <input type="hidden" name="task_taken_id" value={{ task_taken.id }}>
                                                            <input type="hidden" name="student_id" value={{ task_taken.first_user.id }}>
                                                            <span class="label {% if task_taken.first_user_score == task.score_max %} label-success {% else %} label-warning {% endif %}">
                                                                <input class="form-control" name="score" type="text" maxlength="3" autocomplete="off" value={{ task_taken.first_user_score|floatformat }}>
                                                            </span>
                                                        </fieldset>
                                                    </form>
                                                {% else %}
                                                    <span class="label {% if task_taken.first_user_score == task.score_max %} label-success {% else %} label-warning {% endif %}">{{ task_taken.first_user_score|floatformat }}</span>
                                                {% endif %}
                                            </td>
										</tr>
                                        {% if task_taken.second_user %}
                                        <tr>
											<td style="width:30%">
												{{ task_taken.second_user.last_name }} {{ task_taken.second_user.first_name }}
											</td>
                                            <td style="width:20%">
                                                {% if task.can_score %}
                                                <form action={% url "courses.new_pythontask.score_task" %}>
                                                        <fieldset class="form-group">
                                                            <input type="hidden" name="course_id" value={{ course.id }}>
                                                            <input type="hidden" name="task_taken_id" value={{ task_taken.id }}>
                                                            <input type="hidden" name="student_id" value={{ task_taken.second_user.id }}>
                                                            <span class="label {% if task_taken.second_user_score == task.score_max %} label-success {% else %} label-warning {% endif %}">
                                                                <input class="form-control" name="score" type="text" maxlength="3" autocomplete="off" value={{ task_taken.second_user_score|floatformat }}>
                                                            </span>
                                                        </fieldset>
                                                    </form>
                                                {% else %}
                                                    <span class="label {% if task_taken.second_user_score == task.score_max %} label-success {% else %} label-warning {% endif %}">{{ task_taken.second_user_score|floatformat }}</span>
                                                {% endif %}
                                            </td>
										</tr>
                                        {% endif %}
                                        {% if task_taken.third_user %}
                                        <tr>
											<td style="width:30%">
												{{ task_taken.third_user.last_name }} {{ task_taken.third_user.first_name }}
											</td>
                                            <td style="width:20%">
                                                {% if task.can_score %}
                                                <form action={% url "courses.new_pythontask.score_task" %}>
                                                        <fieldset class="form-group">
                                                            <input type="hidden" name="course_id" value={{ course.id }}>
                                                            <input type="hidden" name="task_taken_id" value={{ task_taken.id }}>
                                                            <input type="hidden" name="student_id" value={{ task_taken.third_user.id }}>
                                                            <span class="label {% if task_taken.third_user_score == task.score_max %} label-success {% else %} label-warning {% endif %}">
                                                                <input class="form-control" name="score" type="text" maxlength="3" autocomplete="off" value={{ task_taken.third_user_score|floatformat }}>
                                                            </span>
                                                        </fieldset>
                                                    </form>
                                                {% else %}
                                                    <span class="label {% if task_taken.third_user_score == task.score_max %} label-success {% else %} label-warning {% endif %}">{{ task_taken.third_user_score|floatformat }}</span>
                                                {% endif %}
                                            </td>
										</tr>
                                        {% endif %}
                                        </tbody>
								        </table>
									{% endfor %}
						</td>
						{% endif %}
					</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
</div>
{% include "courses/task.html" %}
{% endblock %}

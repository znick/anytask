{% load i18n %}

<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.12/css/dataTables.bootstrap4.min.css"/>
<link rel="stylesheet" type="text/css"
      href="https://cdn.datatables.net/rowgroup/1.0.0/css/rowGroup.bootstrap4.min.css"/>
<link rel="stylesheet" type="text/css"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.css"/>

<script type="text/javascript" src="https://cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.10.12/js/dataTables.bootstrap4.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/rowgroup/1.0.0/js/dataTables.rowGroup.min.js"></script>
<script src="{{ STATIC_URL }}jquery.validate.min.js"></script>
<script type="text/javascript" src="https://fastcdn.org/Readmore.js/2.1.0/readmore.min.js"></script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.min.js"></script>


<script type="text/javascript">
    $.fn.dataTable.ext.type.search.searchInput = function (data) {
        return $('span.search-value', data).text();
    };

    $.fn.dataTable.ext.type.search.searchSelect = function (data) {
        var res = [];
        if (data)
            $('span.search-value', $(data)).each(function () {
                res.push($(this).prop("id"));
            });

        return JSON.stringify(res);
    };

    $.fn.dataTable.ext.search.push(
        function (settings, data, dataIndex) {
            var api = new $.fn.dataTable.Api(settings);
            var res = true;

            api.columns().header().to$().each(function (i) {
                var $select = $("select", this);
                if ($select.length) {
                    var col_data = JSON.parse(data[i]);
                    if ($select.val() && col_data.indexOf($select.val()) === -1)
                        res = false
                }
                else {
                    var $input = $("input", this);
                    if ($input.val() && data[i].toLowerCase().indexOf($input.val().toLowerCase()) === -1)
                        res = false
                }
            });

            return res;
        }
    );


    $(document).ready(function () {
        $('span.nav-link', '#nav_schools').click(function (e) {
            var $span = $(this);
            window.location.hash = $span.attr("href");
            init_main_table($($span.data("table")));
        });

        $('span.nav-link', '#nav_schools').on('shown.bs.tab', function () {
            var $span = $(this);
            init_main_table($($span.data("table"))).draw();
        });

        var url_hash = window.location.hash ? window.location.hash : $('span.nav-link:first-child', '#nav_schools').attr("href");
        $('span.nav-link[href="' + url_hash + '"]', '#nav_schools').click();

        $(window).resize(function () {
            $.fn.dataTable.tables({visible: true, api: true}).draw();
        });

        $(document).on('hidden.bs.modal', function (event) {
            if ($('.modal:visible').length) {
                $('body').addClass('modal-open');
            }
        });

        $('select, input', "#modal_new_role_settings").each(function () {
            var $select = $(this);
            var $modal = $("#modal_role");
            var select_type_dict = {};
            if ($modal.data("select_type"))
                select_type_dict = $modal.data("select_type");

            if ($select.data("type"))
                select_type_dict[$select.data("type")] = $select[0].outerHTML;
            else
                select_type_dict[$select.closest('div').data("type")] = $select.closest('div')[0].outerHTML;

            $modal.data('select_type', select_type_dict);
        });

        $('#modal_add_group_select, #modal_add_status_select').multiselect({
            templates: {
                ul: '<ul class="multiselect-container dropdown-menu" style="left:inherit;top: inherit;"></ul>',
                li: '<li><a tabindex="0" class="dropdown-item"><label></label></a></li>',
                filter: '<li class="multiselect-item filter"><div class="input-group"><input class="form-control multiselect-search" type="text"></div></li>',
                filterClearBtn: '<span class="input-group-btn"><button class="btn btn-secondary btn-block multiselect-clear-filter" type="button"><i class="fa fa-times"></i></button></span>'

            },
            enableClickableOptGroups: true,
            includeSelectAllOption: true,
            enableCaseInsensitiveFiltering: true,
            filterPlaceholder: "{% trans 'najti' %}",
            selectAllText: '{% trans "vydelit_vse" %}',
            selectAllName: 'task_group_id_all',
            selectAllValue: 'on',
            buttonContainer: '<div style="width:100%;" class="multiselect-dropdown"/>',
            onInitialized: function (option, dropdown, select) {
                $('.multiselect-group a', dropdown).prop('tabindex', '0').addClass('dropdown-item').find('label').addClass('checkbox');
                $(dropdown).addClass("open");
                $(".dropdown-toggle", dropdown).remove();
                $(".multiselect-container", dropdown).removeClass("dropdown-menu").addClass("build-in");
                $(".multiselect-clear-filter", dropdown).click(function () {
                    $(this).blur();
                });
                $("li:not(.filter)", dropdown).each(function () {
                    $(this).prop("title", $.trim($("label", this).text()));
                });
            }
        });

        $('#modal_add_group').on('hidden.bs.modal', function (e) {
            $("input.multiselect-search", this).val("");
            $('#modal_add_group_select, #modal_add_status_select').multiselect('deselectAll', false);
        });

        init_multiselect_and_tagsinput($("#modal_new_role_settings"), false);

        $('body').on("click", "a.change-roles", function () {
            var d = "disabled";
            var $btn = $(this);
            var $tr_main = $btn.closest("tr");
            var $modal = $("#modal_role");
            $("#modal_new_role_settings").removeClass("in");
            $("#modal_new_role_collapse").removeClass("in");
            $('span', '#modal_role_header').text($tr_main.find('span.user-fullname').text());

            $modal.modal("show");

            var user_info = {
                "schools": {}
            };
            user_info["schools"][$tr_main.closest("table").data("school_id")] = 1;
            $('td', $tr_main).each(function () {
                var $td = $(this);
                var type = $td.data("type");
                if (type) {
                    if (!user_info.hasOwnProperty(type))
                        user_info[type] = {};
                    $('span.search-value', $td).each(function () {
                        user_info[type][$(this).data("id")] = 1;
                    });
                }
            });
            $modal.data("user_info", user_info);
            $modal.data("user_id", $tr_main.data("user_id"));
            $modal.data("school_id", $tr_main.data("school_id"));
            $modal.data("deleted_roles", []);
            $modal.data("user_roles_changes", {});

            $(".loading", "#modal_role").show();
            $("#modal_role_body").removeClass("in");
            $('button', "#modal_role").addClass(d).attr(d, d).prop(d, true);
            $modal.data("loading", true);

            var get_data = {
                "user_id": $tr_main.data("user_id"),
                "school_id": $tr_main.data("school_id")
            };

            $.get('{% url staff.views.ajax_get_user_roles_info %}', get_data)
                .always(function (data) {
                    $('button', "#modal_role").removeClass(d).removeAttr(d).prop(d, false);
                    $(".loading", "#modal_role").hide();
                    $("#modal_new_role_collapse").removeClass("in");
                    $("#modal_role_body").collapse("show");
                    $modal.data("loading", false)
                })
                .done(function (data) {
                    create_modal_body(data);
                    $modal.data("roles_info", data);
                })
                .fail(function (data) {
                    $modal.modal("hide");
                });
        });

        $("#modal_role").on("hide.bs.modal", function (e) {
            if ($(this).data("loading"))
                e.preventDefault();
        });

        $("#modal_new_role").on("change", "#modal_new_role_select", function () {
            var $select = $(this);
            var $modal = $("#modal_role");
            var $modal_new_role_table = $("#modal_new_role_table");
            $('#modal_new_role_settings').removeClass("in");
            $('#modal_new_role_adv_settings_btn').removeClass("active");
            $modal_new_role_table.find("tbody").empty();
            $modal.data("role_id", '');
            var role_id = $select.val();
            if (!role_id) {
                return;
            }
            var data = $modal.data("roles_info");
            var user_info = $modal.data("user_info");
            var $table = $("table", $modal_new_role_table);
            $modal.data("role_id", role_id);

            var type_used = create_modal_table($table, role_id, user_info, data, "roles", 'new');
            var $modal_settings = $('#modal_new_role_simple_settings');
            $("select", $modal_settings).each(function () {
                var $select_type = $(this);
                var type = $select_type.data("type");
                if (type in type_used)
                    $select_type.closest('.form-group').show();
                else
                    $select_type.closest('.form-group').hide();

                if (user_info.hasOwnProperty(type))
                    $("option", $select_type).each(function () {
                        var $option = $(this);
                        if (user_info[type].hasOwnProperty($option.val()))
                            $option.attr('selected', 'selected');
                        else
                            $option.removeAttr("selected");
                    });
            }).multiselect('refresh');

            $(".users-or-groups", $modal_settings).each(function () {
                var $input = $(this);
                var type = $input.closest(".users-or-groups-div").data("type");
                if (type in type_used)
                    $input.closest('.form-group').show();
                else
                    $input.closest('.form-group').hide();

            }).tagsinput('removeAll');
        });

        $("#modal_new_role_adv_settings_btn").click(function () {
            $(this).blur().button('toggle');
        });

        $("#modal_add_group_ok").click(function () {
            var $input_for = $($('#modal_add_group').data('for'));
            $('optgroup', "#modal_add_group_select, #modal_add_status_select").each(function () {
                var $optgroup = $(this);
                if (!$optgroup.data("not_selectable") && $optgroup.data("count") === $("option:selected", this).length) {
                    $input_for.tagsinput('add', {
                        type: "course",
                        id: "c_" + $optgroup.data("id"),
                        id_post: $optgroup.data("id"),
                        fullname: $optgroup.attr("label")
                    });
                }
                else {
                    $("option:selected", this).each(function () {
                        var $option = $(this);

                        $input_for.tagsinput('add', {
                            type: $option.data("type"),
                            id: $option.data("type")[0] + "_" + $option.data("id"),
                            id_post: $option.data("id"),
                            fullname: $option.text()
                        });
                    });
                }
            });
        });

        $("#modal_role_ok").click(function () {
            var $btn = $(this);
            $btn.blur();

            var $modal = $("#modal_role");
            var is_forms_valid = true;
            $('form', $modal).each(function () {
                var $form = $(this);
                if (!$form.valid()) {
                    var $tab = $form.closest("div.tab-pane");
                    if (!$tab.hasClass("active")) {
                        $('span[aria-controls="' + $tab.attr("id") + '"]', "#modal_role_body").trigger("click");
                    }

                    var $block = $form.closest("div.form-block");
                    if (!$block.hasClass("active")) {
                        $block.addClass("active").attr("aria-expanded", "true");
                        $block.siblings(".form-block-toggle").trigger("click");
                    }
                    is_forms_valid = false;
                    return false;
                }
            });

            if (is_forms_valid) {
                var d = "disabled";

                $btn.data('saving', true);
                $btn.data('reset_text', $btn.html());
                $btn.html($btn.data('loading_text'));
                $('button', $modal).addClass(d).attr(d, d).prop(d, true);

                var $form_new_role = $('#modal_new_role_form');
                var new_role_perms = {};

                $("select", $form_new_role).each(function () {
                    var $select = $(this);
                    new_role_perms[$select.data("perm_id")] = $select.val();
                });

                $("input.users-or-groups", $form_new_role).each(function () {
                    var $input = $(this);
                    new_role_perms[$input.data("perm_id")] = {
                        'users': $input.data('user'),
                        'groups': $input.data('group'),
                        'courses': $input.data('course'),
                        'statuses': $input.data('status')
                    };
                });

                var post_data = {
                    "csrfmiddlewaretoken": $btn.data("csrf_token"),
                    "user_id": $modal.data("user_id"),
                    "school_id": $modal.data("school_id"),
                    "deleted_roles": $modal.data("deleted_roles"),
                    "new_role_perms": JSON.stringify(new_role_perms),
                    "user_roles_changes": JSON.stringify($modal.data("user_roles_changes"))
                };

                if ($modal.data("role_id"))
                    post_data["role_id"] = $modal.data("role_id");

                $.post('{% url staff.views.ajax_save_user_roles %}', post_data)
                    .always(function (data) {

                    })
                    .done(function (data) {
                        $btn.addClass("btn-success").text("{% trans "uspeshno" %}");
                        window.location.reload();
                    })
                    .fail(function (data) {
                        $btn.data('saving', false);

                        $('button', $modal).removeClass(d).removeAttr(d).prop(d, false);
                        $btn.html($btn.data('reset_text'));
                    });
            }
        });
    });

    function init_main_table($table) {
        var data_table;
        if ($.fn.DataTable.isDataTable($table)) {
            data_table = $table.DataTable();
        }
        else {
            data_table = $table.DataTable({
                scrollY: "60vh",
                scrollX: true,
                scrollCollapse: true,
                paging: true,
                order: [[1, 'asc']],
                autoWidth: false,
                dom: "<'row'<'col-xs-12'tr>>" +
                "<'row table-users-info'<'col-xs-12 col-sm-12 col-md-4 col-lg-4'i><'col-xs-12 col-sm-12 col-md-8 col-lg-8'p>>",
                columnDefs: [
                    {
                        "targets": "searchable-select",
                        "type": "searchSelect"
                    },
                    {
                        "targets": "searchable-input",
                        "type": "searchInput"
                    },
                    {
                        "targets": "no-sort",
                        "orderable": false
                    },
                    {
                        "targets": "th-settings",
                        "orderable": false,
                        "width": "1%"
                    }
                ],
                language: {
                    "decimal": "",
                    "emptyTable": "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% trans 'pustaja_tablica' %}",
                    "thousands": ",",
                    "loadingRecords": "{% trans 'zagruzka' %}",
                    "processing": "{% trans 'vychislenie' %}",
                    "info": "_TOTAL_",
                    "infoEmpty": "0",
                    "infoFiltered": "({% trans 'iz' %} _MAX_)",
                    "infoPostFix": "",
                    "zeroRecords": "{% trans 'nichego_ne_najdeno' %}",
                    "paginate": {
                        "next": '<i class="fa fa-angle-right" aria-hidden="true"></i>',
                        "previous": '<i class="fa fa-angle-left" aria-hidden="true"></i>'
                    }
                },
                initComplete: function (settings, json) {
                    var $table = $(this);
                    var $container = $table.closest(".table-container");
                    $container.siblings('.loading-table-img').hide();
                    $container.show();

                    this.api().columns(".searchable-input").every(function () {
                        var column = this;
                        var input = $('<div class="search search-input"><input class="form-control form-control-sm" type="text" placeholder="{% trans "najti" %}" /></div>')
                            .appendTo($(column.header()))
                            .on('keyup change', function () {
                                var val = $(this).val();

                                column.search(val).draw();
                            });
                    });

                    this.api().columns(".searchable-select").every(function () {
                        var column = this;
                        var select = $('<div class="search search-select"><select class="form-control form-control-sm"><option value=""></option></select></div>')
                            .appendTo($(column.header()))
                            .on('change', function () {
                                var val = $(this).val();

                                column.search(val).draw();
                            });

                        var select_dict = {};
                        column.data().unique().sort().each(function (d) {
                            $(d).find(".search-value").each(function () {
                                var $span = $(this);
                                if (!select_dict.hasOwnProperty($span.prop("id"))) {
                                    $('select', select).append('<option value="' + $span.prop("id") + '">' + $span.text() + '</option>');
                                    select_dict[$span.prop("id")] = $span.text();
                                }
                            });
                        });
                    });

                    $("div.search", $container).find("select, input").click(function (e) {
                        e.stopPropagation();
                    });

                    $table.DataTable().draw();
                    $("ul", ".dataTables_paginate").addClass("pagination-sm");

                },
                drawCallback: function (settings) {
                    $("ul", ".dataTables_paginate").addClass("pagination-sm");
                }
            });
        }

        return data_table;
    }

    function create_modal_body(data) {
        var $modal_roles_accordion = $("#modal_roles_accordion");
        $modal_roles_accordion.html('');
        var show_edit_button = false;
        if (data.hasOwnProperty("user_roles")) {
            for (var user_role_id in data["user_roles"]) {
                show_edit_button = true;
                var $card = $('' +
                    '<div class="card" id="user_role_card_' + user_role_id + '">' +
                    '  <div class="card-header form-block-toggle" role="tab" id="user_role_header_' + user_role_id + '" data-toggle="collapse" data-parent="#modal_roles_accordion" href="#user_role_collapse_' + user_role_id + '" aria-expanded="true" aria-controls="user_role_collapse_' + user_role_id + '">' +
                    '    <a class="card-link" >' +
                    '    </a>' +
                    '    <span class="fa fa-trash-o btn-delete-role" data-toggle="popover-delete-role" tabindex="0" data-role_id="' + user_role_id + '" aria-hidden="true"></span>' +
                    '  </div>' +
                    '  <div id="user_role_collapse_' + user_role_id + '" class="collapse user-role-collapse form-block" role="tabpanel" aria-labelledby="user_role_header_' + user_role_id + '">' +
                    '    <div class="card-block table-collapse collapse block-height">' +
                    '      <form>' +
                    '        <table class="table table-striped table-bordered table-roles" data-edit_role="true">' +
                    '          <thead><tr></tr></thead>' +
                    '          <tbody></tbody>' +
                    '        </table>' +
                    '      </form>' +
                    '    </div>' +
                    '  </div>' +
                    '</div>'
                ).appendTo($modal_roles_accordion);
                $("div.card-header", $card).find("a").text(data["user_roles"][user_role_id]["name"]);

                var $table = $("table", $card);
                create_modal_table($table, user_role_id, {}, data, "user_roles", 'user');

            }
        }

        $('span.btn-delete-role', "#modal_roles_accordion").popover({
            trigger: 'manual',
            html: true,
            template: '<div class="popover" role="tooltip">' +
            '<div class="popover-arrow"></div>' +
            '<div class="popover-content"></div>' +
            '<div class="popover-footer">' +
            '<button class="btn btn-sm btn-secondary" type="button" data-dismiss="popover"><i class="fa fa-times"></i></button>' +
            '<button class="btn btn-sm btn-danger btn-delete-role-ok" type="button"><i class="fa fa-trash-o"></i></button>' +
            '</div>' +
            '</div>',
            content: function () {
                var $span = $('<span class="popover-data"></span>')
                    .attr("data-role_card_id", "#" + $(this).closest("div.card").attr("id"))
                    .attr("data-role_id", $(this).data("role_id"))
                    .text("{% trans "udalit_rol_vopros" %}");

                return $span[0].outerHTML;
            }
        })
            .on('click', function (e) {
                e.stopPropagation();
                $('span.btn-delete-role', "#modal_roles_accordion").not(this).popover('hide');
                $(this).popover('toggle');
            })
            .on('shown.bs.popover', function () {
                var $popover = $(this);

                $(document).one('click', oneClickHandler);

                function oneClickHandler(event) {
                    if ($(event.target).data('toggle') !== 'popover-delete-role') {
                        $popover.popover('hide');
                    } else {
                        $(document).one('click', oneClickHandler);
                    }
                }
            });

        $('body').on("click", "button.btn-delete-role-ok", function () {
            var $span_data = $(this).closest("div.popover").find("span.popover-data");
            var $modal = $("#modal_role");
            $modal.data("deleted_roles").push($span_data.data("role_id"));
            delete $modal.data("user_roles_changes")[$span_data.data("role_id")];
            $($span_data.data("role_card_id"), "#modal_role").hide();
        });

        $('.user-role-collapse').on('show.bs.collapse', function () {
            var $table = $("table", this);
            $("tr.group.group-start", $table).find("td").attr("colspan", 2);
            $(this).addClass("active")
        }).on('hide.bs.collapse', function () {
            $(this).removeClass("active")
        });

        $('#modal_new_role_settings').on('show.bs.collapse', function () {
            $('#modal_new_role_table').removeClass("hidden");
        });

        var $select = $("#modal_new_role_select").html('');
        $select.append('<option class="multiselect-zero-item" value="">---</option>');
        if (data.hasOwnProperty("roles")) {
            var roles = {};

            for (var school_name in data["roles"]) {
                var $opt_group = $('<optgroup label="' + school_name + '"></optgroup>').appendTo($select);
                for (var role_id in data["roles"][school_name]) {
                    roles[role_id] = data["roles"][school_name][role_id];
                    $opt_group.append('<option class="multiselect-1st-subitem" value="' + role_id + '">' + data["roles"][school_name][role_id]["name"] + '</option>');
                }
            }
            data["roles"] = roles;
        }

        $select.multiselect("destroy").multiselect({
            buttonContainer: '<div style="width:100%;" class="multiselect-dropdown dropdown"/>',
            buttonClass: 'btn btn-secondary btn-table',
            templates: {
                ul: '<ul class="multiselect-container dropdown-menu dropdown-menu-right ul-role-select"></ul>',
                li: '<li><a tabindex="0" class="dropdown-item"><label></label></a></li>',
            },
            maxHeight: 200,
            onInitialized: function (select, dropdown) {
                $('.multiselect-group a', dropdown).prop('tabindex', '0').addClass('dropdown-item');
            },
        });

        if (show_edit_button)
            $("#modal_nav_role_user_roles").removeClass("hidden");
        else
            $("#modal_nav_role_user_roles").addClass("hidden");

        if (Object.keys(data["roles"]).length)
            $("#modal_nav_role_new_role").removeClass("hidden");
        else
            $("#modal_nav_role_new_role").addClass("hidden");


        $('li:not(".hidden"):first span', "#modal_nav_role").click();
    }

    function create_modal_table($table, role_id, user_info, data, data_key, prefix) {
        if ($.fn.DataTable.isDataTable($table)) {
            $table.DataTable().destroy();
        }
        var select_type_dict = $('#modal_role').data('select_type');
        var type_used = {};
        var $thead = $('thead', $table).show().find("tr").html('');
        var $tbody = $('tbody', $table).html('');
        $thead.append('<th class="disable-ordering">{% trans 'dostupy' %}</th>');
        $thead.append('<th></th>');
        if (data.hasOwnProperty(data_key) && data[data_key].hasOwnProperty(role_id)) {
            $thead.append('<th class="disable-ordering" data-perm_id="' + data[data_key][role_id] + '">' + data[data_key][role_id]["name"] + '</th>');
            if (data[data_key][role_id].hasOwnProperty("perms"))
                for (var perm_id in data[data_key][role_id]["perms"]) {
                    var $tr = $('<tr></tr>').appendTo($tbody);
                    $tr.append('<td>' + data[data_key][role_id]["perms"][perm_id]["name"] + '</td>');
                    $tr.append('<td>' + data[data_key][role_id]["perms"][perm_id]["model_name"] + '</td>');
                    var $td = $('<td class="centered"></td>').appendTo($tr);
                    var type = data[data_key][role_id]["perms"][perm_id]["model"];
                    if (select_type_dict.hasOwnProperty(type) &&
                        !(data['perms_global'].hasOwnProperty(type) && data['perms_global'][type].indexOf(data[data_key][role_id]["perms"][perm_id]["codename"]) !== -1)) {
                        type_used[type] = 1;

                        var $select_type = $(select_type_dict[type]);
                        $select_type.appendTo($td);
                        if ($select_type.attr("multiple")) {
                            $select_type.attr("name", prefix + "_" + role_id + "_select_" + perm_id);
                            $select_type.attr("data-perm_id", perm_id);
                            $select_type.attr("data-role_id", role_id);
                            $select_type.addClass("validate");

                            var user_type_info = {};
                            if (user_info.hasOwnProperty(type))
                                user_type_info = user_info[type];

                            $("option", $select_type).each(function () {
                                var $option = $(this);
                                if (
                                    user_type_info.hasOwnProperty($option.val()) ||
                                    (
                                        data[data_key][role_id]["perms"][perm_id].hasOwnProperty("objects") &&
                                        data[data_key][role_id]["perms"][perm_id]["objects"]["objects"].indexOf(parseInt($option.val(), 10)) !== -1
                                    )
                                )
                                    $option.attr('selected', 'selected').attr("data-selected", true);
                            });
                        }
                        else {
                            var $input = $select_type.find("input");
                            var name = prefix + "_" + role_id + "_input_" + perm_id;
                            $input.attr("name", name).attr("id", name);
                            $input.attr("data-perm_id", perm_id);
                            $input.attr("data-role_id", role_id);

                            $input.addClass("validate");
                            if (data[data_key][role_id]["perms"][perm_id].hasOwnProperty("objects"))
                                $input.data("preint_data", data[data_key][role_id]["perms"][perm_id]["objects"]);
                        }
                    }
                    else {
                        $td.append('<input type="checkbox" checked="checked" disabled="disabled">');
                    }
                }
        }

        init_modal_table($table);

        return type_used
    }

    function user_role_change(user_roles_changes, obj_id, is_added) {
        var remove = 'remove';
        var add = 'add';
        if (!is_added)
            remove = [add, add = remove][0];
        var i = -1;
        if (typeof obj_id === 'object')
            for (var j = 0; j < user_roles_changes[remove].length; ++j) {
                if (user_roles_changes[remove][j].type === obj_id.type && user_roles_changes[remove][j].id === obj_id.id) {
                    i = j;
                    break;
                }
            }
        else
            i = user_roles_changes[remove].indexOf(obj_id);
        if (i !== -1) {
            user_roles_changes[remove].splice(i, 1);
        }
        else
            user_roles_changes[add].push(obj_id);

        return user_roles_changes
    }

    function user_role_change_input($input, item, is_added) {
        var $modal = $("#modal_role");
        var user_roles_changes = $modal.data("user_roles_changes");
        var role_id = $input.data("role_id");
        var perm_id = $input.data("perm_id");

        if (!user_roles_changes.hasOwnProperty(role_id))
            user_roles_changes[role_id] = {};

        if (!user_roles_changes[role_id].hasOwnProperty(perm_id))
            user_roles_changes[role_id][perm_id] = {
                "add": [],
                "remove": []
            };

        var obj = {
            "type": item.type,
            "id": item.id_post
        };
        user_roles_changes[role_id][perm_id] = user_role_change(user_roles_changes[role_id][perm_id], obj, is_added);

        $modal.data("user_roles_changes", user_roles_changes);
    }

    function sync_multiselect_checkboxes($select) {
        var $ul = $select.closest("span.multiselect-native-select").find("ul.multiselect-container");
        var parent_ids = {};
        $select.find("option").each(function () {
            var $option = $(this);
            if ($option.data("parent_id")) {
                if (!parent_ids.hasOwnProperty($option.data("parent_id")))
                    parent_ids[$option.data("parent_id")] = {
                        "checked": false,
                        "not_checked": false
                    };
                parent_ids[$option.data("parent_id")][$option.attr("selected") ? "checked" : "not_checked"] = true;
            }
            var $input = $ul.find('input[value="' + $option.val() + '"]');
            $input.prop('checked', !!$option.attr("selected"));
            if (!!$option.attr("selected"))
                $input.attr("checked", "checked");
            else
                $input.removeAttr("checked");
        });

        while (Object.keys(parent_ids).length) {
            var new_parent_ids = {};
            for (var parent_id in parent_ids) {
                var $input = $ul.find('input[value="' + parent_id + '"]');
                var checked = parent_ids[parent_id]["checked"] && !parent_ids[parent_id]["not_checked"];
                $input.prop('checked', checked);
                if (checked)
                    $input.attr("checked", "checked");
                else
                    $input.removeAttr("checked");

                var id = $select.find('optgroup[value="' + parent_id + '"]').data("parent_id");
                if (id) {
                    if (!new_parent_ids.hasOwnProperty(id))
                        new_parent_ids[id] = {
                            "checked": false,
                            "not_checked": false
                        };
                    new_parent_ids[id][checked ? "checked" : "not_checked"] = true;
                }
            }
            parent_ids = new_parent_ids;
        }
    }

    function init_multiselect_and_tagsinput($table, is_validate) {
        var form_validator;
        if (is_validate)
            form_validator = $($table).closest("form").validate({
                ignore: ':hidden:not(".validate")',
                highlight: function (input) {
                    $(input).closest("td").removeClass('has-success').addClass('has-danger');
                },

                success: function (label) {
                    label.closest('td').removeClass('has-danger');
                },

                errorPlacement: function (error, element) {
                    $(element).closest("td").append(error);
                }
            });

        var $select = $("select[multiple]", $table).multiselect({
            buttonContainer: '<div style="width:100%;" class="multiselect-dropdown dropdown"/>',
            buttonClass: 'btn btn-secondary btn-table',
            templates: {
                ul: '<ul class="multiselect-container dropdown-menu dropdown-menu-right"></ul>',
                li: '<li><a tabindex="0" class="dropdown-item"><label></label></a></li>',
                filter: '<li class="multiselect-item filter"><div class="input-group"><input class="form-control form-control-sm multiselect-search" type="text"></div></li>',
                filterClearBtn: '<span class="input-group-btn"><button class="btn btn-secondary btn-sm multiselect-clear-filter" type="button"><span class="fa fa-times"></span></button></span>'
            },
            maxHeight: 200,
            manualUpdateOptGroups: true,
            enableClickableOptGroups: true,
            enableCaseInsensitiveFiltering: true,
            filterPlaceholder: "{% trans "najti" %}",
            buttonTitle: function (options, select) {
                var labels = [];

                if (options.length === 0) {
                    return '---';
                }
                else {
                    options.each(function () {
                        labels.push($(this).text());
                    });
                }
                return labels.join(', ');
            },
            buttonText: function (options, select) {
                var $option = select.find('option[selected="selected"]');
                if ($option.length === 0) {
                    return '---';
                }

                return '{% trans "vybrano" %}: ' + $option.length;
            },
            onInitialized: function (select, dropdown) {
                $('.multiselect-group a', dropdown).prop('tabindex', '0').addClass('dropdown-item').find('label').addClass('checkbox');
                sync_multiselect_checkboxes($(select));
            },
            onChange: function (option, checked) {
                var $this_select = $(option[0]).closest("select");
                if (!$this_select.length)
                    return;

                var $ul = $this_select.closest("span.multiselect-native-select").find("ul.multiselect-container");
                for (var opt_i = 0; opt_i < option.length; ++opt_i) {
                    var $opt = $(option[opt_i]);
                    var $opts_to_change = $this_select.find('option[value="' + $opt.val() + '"]');
                    var $ul_inputs = $ul.find('input[value="' + $opt.val() + '"]');

                    if (checked)
                        $opts_to_change.attr("selected", "selected");
                    else
                        $opts_to_change.removeAttr("selected");
                }

                var type = $this_select.data("type");

                if (is_validate) {
                    form_validator.element($this_select);
                    $('select[data-type="' + type + '"]', $this_select.closest(".table-collapse").find(".mass-select")).val('').multiselect('refresh');
                }
                else {
                    var $table_select = $('select[data-type="' + type + '"]', $this_select.closest(".table-collapse").find("table.table-roles"));
                    if ($table_select.length)
                        $table_select
                            .val($this_select.val())
                            .multiselect('refresh')
                            .closest("form").valid();
                }
                sync_multiselect_checkboxes($this_select);
                if ($table.data("edit_role")) {
                    var $modal = $("#modal_role");
                    var user_roles_changes = $modal.data("user_roles_changes");
                    var role_id = $this_select.data("role_id");
                    var perm_id = $this_select.data("perm_id");

                    if (!user_roles_changes.hasOwnProperty(role_id))
                        user_roles_changes[role_id] = {};

                    if (!user_roles_changes[role_id].hasOwnProperty(perm_id))
                        user_roles_changes[role_id][perm_id] = {
                            "add": [],
                            "remove": []
                        };

                    $(option).each(function () {
                        var $option = $(this);
                        var obj_id = $option.val();

                        if ($option.is(":checked") === !!$option.data("selected")) {
                            $(["add", "remove"]).each(function (index, item) {
                                var i = user_roles_changes[role_id][perm_id][item].indexOf(obj_id);
                                if (i !== -1) {
                                    user_roles_changes[role_id][perm_id][item].splice(i, 1);
                                }
                            });

                        }
                        else {
                            user_roles_changes[role_id][perm_id] = user_role_change(user_roles_changes[role_id][perm_id], obj_id, $option.is(":checked"));
                        }
                    });

                    $modal.data("user_roles_changes", user_roles_changes);
                }
            },
        });

        $("li.multiselect-item-main").find("input").change(function () {
            var $input_select = $(this);
            var checked_str = ':checked';
            if ($input_select.is(":checked"))
                checked_str = ':not(:checked)';
            var $ul = $input_select.closest("ul.multiselect-container");
            $input_select.closest("span.multiselect-native-select").find('select [data-parent_id="' + $input_select.val() + '"]').each(function () {
                $ul.find('li:not(.multiselect-item-main) input[value=' + $(this).attr("value") + ']' + checked_str)
                    .trigger("click");
            });
        });

        var MAX_SEARCH_SGS = 6;
        var users_bloodhound = new Bloodhound({
            datumTokenizer: function (datum) {
                return Bloodhound.tokenizers.whitespace(datum.fullname);
            },
            queryTokenizer: Bloodhound.tokenizers.whitespace,
            remote: {
                wildcard: '%QUERY',
                url: '{% url search.views.ajax_search_users %}?q=%QUERY&self=1&max=' + MAX_SEARCH_SGS,
                transform: function (response) {
                    $('#navbar_search').data('up_limited', response.is_limited);
                    return $.map(response.result, function (user) {
                        return $.extend({}, user, {
                            'id': "u_" + user.id,
                            'id_post': user.id,
                            'type': "user"
                        });
                    });
                }
            }
        });

        var $input = $('.users-or-groups', $table).tagsinput({
            maxTags: 25,
            itemValue: 'id',
            itemText: 'fullname',
            focusClass: 'focus',
            tagClass: function (item) {
                switch (item.type) {
                    case 'user'   :
                        return 'label label-success';
                    case 'group'  :
                        return 'label label-info';
                    case 'course':
                        return 'label label-primary';
                    case 'status':
                        return 'label label-warning';
                }
            },
            typeaheadjs: [
                {
                    highlight: true,
                    hint: false,
                    minLength: 3
                },
                {
                    name: 'users',
                    displayKey: 'fullname',
                    source: users_bloodhound.ttAdapter(),
                    templates: {
                        suggestion: function (data) {
                            var table_html = '<div class="sgs-result-up" data-url="{0}"><table>' +
                                '<tr><td style="padding-right: 10px;"><img class="avatar" src="{1}" style="width: 30px; height: 30px;"></td>' +
                                '<td><div><strong>{2}</strong></div>{3}</td></tr>' +
                                '<tr><td></td><td>{4}</td></tr>' +
                                '<tr><td></td><td><strong>{% trans "loginy" %}</strong></td></tr>' +
                                '<tr><td></td><td>{5}@ <small class="text-muted">Anytask</small></td></tr>' +
                                '{6}' +
                                '{7}' +
                                '</table></div>';
                            var email_html = '';
                            var ya_contest_login_html = '';
                            var ya_passport_email_html = '';
                            var avatar = data.avatar;
                            var status_html = '';
                            var status_template = '<span class="label label-status-sgs" style="background-color: {0}">{1}</span>';
                            var MAX_STATUSES = 2;
                            var status_counter = 0;

                            while (status_counter < data.statuses.length) {
                                if (status_counter == MAX_STATUSES) {
                                    status_html += '<span class="label label-status-sgs label-default ">{% trans 'yeshcho' %} ' + (data.statuses.length - MAX_STATUSES) + '</span>';
                                    break;
                                }

                                status_html += status_template.format(data.statuses[status_counter][1], data.statuses[status_counter][0]);
                                ++status_counter;
                            }

                            if (!avatar)
                                avatar = 'https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mm&f=y';
                            if (data.email)
                                email_html = '<div class="sgs-email">{0}</div>'.format(data.email);
                            if (data.ya_contest_login)
                                ya_contest_login_html = '<tr><td></td><td>{0}@ <small class="text-muted">{% trans "jakontest" %}</small></td></tr>'.format(data.ya_contest_login);
                            if (data.ya_passport_email)
                                ya_passport_email_html = '<tr><td></td><td>{0} <small class="text-muted">{% trans "ja.pochta" %}</small></td></tr>'.format(data.ya_passport_email);
                            return table_html.format(data.url, avatar, data.fullname, email_html, status_html, data.username, ya_contest_login_html, ya_passport_email_html)
                        }
                    }
                }
            ]
        });

        $('.tt-menu', $table).on("mouseleave", function () {
            $(this).find('.tt-cursor').removeClass('tt-cursor');
        });

        $(".btn-add-tags", $table).click(function () {
            var $btn = $(this);
            var $input_tags = $btn.siblings("input.users-or-groups");
            var $modal_add_group = $("#modal_add_group");

            $modal_add_group.data("for", '#' + $input_tags.attr("id"));
        });

        if (is_validate) {
            if ($select.length)
                $select.each(function () {
                    $(this).rules('add', {
                        required: true,
                        messages: {
                            required: "required"
                        }
                    });
                });
            for (var i = 0; i < $input.length; ++i) {
                if (!$input[i].$element.data("init")) {
                    $input[i].$element
                        .data('init', true)
                        .data('user', [])
                        .data('group', [])
                        .data('course', [])
                        .data('status', []);
                }

                $input[i].$element.rules('add', {
                    required: true,
                    messages: {
                        required: "required",
                    }
                });
                $input[i].$element.on('itemAdded', function (e) {
                    var $this = $(this);
                    $this.data(e.item.type).push(e.item.id_post);
                    var $div = $this.closest('.form-block.active');
                    if ($div.length)
                        $div.height($this.closest('.block-height').outerHeight());
                    form_validator.element($this);
                    if (!$this.data("mass_change"))
                        $('input.users-or-groups', $this.closest(".table-collapse").find(".mass-select")).tagsinput('removeAll');
                    $this.data("mass_change", false);

                    if ($table.data("edit_role") && !$this.data("preint_data"))
                        user_role_change_input($this, e.item, true);
                }).on('itemRemoved', function (e) {
                    var $this = $(this);
                    var index = $this.data(e.item.type).indexOf(e.item.id_post);
                    if (index !== -1) {
                        $this.data(e.item.type).splice(index, 1)
                    }
                    var $div = $this.closest('.form-block.active');
                    if ($div.length)
                        $div.height($this.closest('.block-height').outerHeight());
                    form_validator.element($this);
                    if (!$this.data("mass_change"))
                        $('input.users-or-groups', $this.closest(".table-collapse").find(".mass-select")).tagsinput('removeAll');
                    $this.data("mass_change", false);

                    if ($table.data("edit_role"))
                        user_role_change_input($this, e.item, false);
                });
                var preint_data = $input[i].$element.data("preint_data");
                for (var tag_key in preint_data)
                    if (preint_data.hasOwnProperty(tag_key)) {
                        for (var j = 0; j < preint_data[tag_key].length; ++j) {
                            $input[i].$element.tagsinput('add', {
                                type: tag_key,
                                id: tag_key[0] + "_" + preint_data[tag_key][j]["id"],
                                id_post: preint_data[tag_key][j]["id"],
                                fullname: preint_data[tag_key][j]["name"]
                            });
                        }
                    }
                $input[i].$element.data("preint_data", false)
            }
        }
        else {
            for (var i = 0; i < $input.length; ++i) {
                $input[i].$element.on('itemAdded', function (e) {
                    var $mass_input = $(this);
                    var $table_input = $('input.users-or-groups', $mass_input.closest(".table-collapse").find("table.table-roles"));
                    if ($table_input.length) {
                        $table_input.tagsinput('removeAll');
                        $table_input.each(function () {
                            $(this)
                                .data('user', [])
                                .data('group', [])
                                .data('course', [])
                                .data('status', []);
                        });
                        var objs = $mass_input.tagsinput('items');
                        for (var j = 0; j < objs.length; ++j) {
                            $table_input.each(function () {
                                $(this).data("mass_change", true);
                            });
                            $table_input.tagsinput('add', objs[j]);
                        }
                    }
                }).on('itemRemoved', function (e) {
                    var $table_input = $('input.users-or-groups', $(this).closest(".table-collapse").find("table.table-roles"));
                    if ($table_input.length) {
                        $table_input.each(function () {
                            $(this).data("mass_change", true);
                        });
                        $table_input.tagsinput('remove', e.item);
                    }
                });
            }
        }
    }

    function init_modal_table($table) {
        init_multiselect_and_tagsinput($table, true);

        $table.DataTable({
            info: false,
            paging: false,
            searching: false,
            order: [[1, 'desc']],
            autoWidth: false,
            rowGroup: {
                dataSrc: 1
            },
            columnDefs: [
                {
                    "targets": 1,
                    "visible": false
                },
                {
                    "targets": "disable-ordering",
                    "orderable": false
                }
            ],
            language: {
                "decimal": "",
                "emptyTable": "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% trans 'pustaja_tablica' %}",
                "thousands": ",",
                "loadingRecords": "{% trans 'zagruzka' %}",
                "processing": "{% trans 'vychislenie' %}"
            },
            initComplete: function (settings, json) {
                var $table = $(this);
                if ($table.attr("for"))
                    $($table.attr("for")).addClass("hidden");
                $table.closest("div.table-collapse").collapse("show");
                $table.DataTable().draw();
                $table.find("thead").hide();
            }
        });

        if ($table.attr("for")) {
            $($table.attr("for")).removeClass("hidden");
            $("#modal_new_role_table").removeClass("active").readmore('destroy').readmore({
                speed: 200,
                collapsedHeight: 0,
                moreLink: '<span class="modal-role-readmore-toggle form-block-toggle">{% trans "rasshirennyye_nastroyki" %}&nbsp;<span class="fa fa-chevron-down"></span></span>',
                lessLink: '<span class="modal-role-readmore-toggle form-block-toggle">{% trans "skryt" %}&nbsp;<span class="fa fa-chevron-up"></span></span>',
                beforeToggle: function (trigger, element, is_close) {
                    $("tr.group.group-start", $table).find("td").attr("colspan", 2);
                    if (is_close)
                        element.removeClass("active");
                },
                afterToggle: function (trigger, element, opened) {
                    if (opened)
                        element.addClass("active");
                    else
                        element.removeClass("active");
                }
            });
        }
    }

</script>